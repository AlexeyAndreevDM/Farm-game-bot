# Динамическое ценообразование в Farm Game Bot

## Описание системы

Реализована система динамического ценообразования на основе спроса. Цены на животных меняются в зависимости от того, насколько активно их покупают игроки.

## Принцип работы

### 1. Отслеживание покупок
- Каждая покупка животного записывается в таблицу `purchase_stats`
- Счетчик покупок увеличивается при каждой транзакции
- Статистика накапливается в течение 24 часов

### 2. Расчет цен
Раз в 24 часа происходит автоматический пересчет цен по формуле:

```
новая_цена = базовая_цена × (1 + коэффициент_спроса × количество_покупок)
```

Где:
- `базовая_цена` - цена животного в прошлый период
- `коэффициент_спроса` = 0.02 (2% прироста за каждую покупку)
- `количество_покупок` - сколько раз купили этого животного за период

Дополнительно добавляется случайная вариация ±5% для разнообразия.

### 3. Цены продажи
Цена продажи всегда составляет **97.0-99.8%** от цены покупки (случайное значение в диапазоне).

### 4. Сброс статистики
После обновления цен:
- Счетчики покупок обнуляются
- Текущие цены становятся новыми базовыми ценами
- Начинается новый период накопления статистики

## Примеры

### Пример 1: Популярный товар
```
Курица (базовая цена 175₽):
- За 24 часа куплено 10 раз
- Новая цена = 175 × (1 + 0.02 × 10) = 175 × 1.2 = 210₽
- С вариацией ±5%: 200-220₽
- Цена продажи: 194-217₽ (97-99.8% от покупной)
```

### Пример 2: Непопулярный товар
```
Лошадь (базовая цена 40000₽):
- За 24 часа куплено 0 раз
- Новая цена = 40000 × (1 + 0.02 × 0) = 40000₽
- С вариацией ±5%: 38000-42000₽
- Цена продажи: 36860-41916₽ (97-99.8% от покупной)
```

## Технические детали

### База данных
Таблица `purchase_stats`:
```sql
CREATE TABLE IF NOT EXISTS purchase_stats (
    animal_name TEXT PRIMARY KEY,
    purchase_count INTEGER DEFAULT 0,
    base_price INTEGER,
    current_price INTEGER,
    last_reset TEXT
)
```

### Базовые цены животных
```python
BASE_PRICES = {
    'Корову': 10000,
    'Свинью': 5500,
    'Кролика': 350,
    'Курицу': 175,
    'Лошадь': 40000,
    'Овечку': 7250,
    'Гуся': 550
}
```

### Файлы системы
- `utils/price_manager.py` - логика ценообразования
- `database/db_manager.py` - работа со статистикой покупок
- `handlers/shop.py` - запись покупок при совершении сделок

## Преимущества системы

1. **Реалистичность** - цены реагируют на спрос, как в реальной экономике
2. **Баланс игры** - популярные животные дорожают, стимулируя покупку других
3. **Стратегия** - игроки могут использовать знание рынка для выгодных покупок
4. **Динамика** - игра не становится однообразной, требует адаптации

## Мониторинг системы

### Просмотр статистики покупок
```python
from database.db_manager import db_manager
stats = db_manager.get_purchase_stats()
for animal, data in stats.items():
    print(f"{animal}: {data['purchase_count']} покупок, цена {data['current_price']}₽")
```

### Принудительное обновление цен (для админа)
```python
from utils.price_manager import price_manager
price_manager.force_update()
```

## Тестирование

Запустите тест системы:
```bash
python3 test_dynamic_pricing.py
```

Тест проверяет:
- Генерацию начальных цен
- Запись статистики покупок
- Влияние спроса на цены
- Корректность диапазона цен продажи (97-99.8%)
- Сброс счетчиков после обновления
